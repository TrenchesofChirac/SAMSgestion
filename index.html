<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAMS - Prise de Service & Admin</title>
<style>
:root{
  --bg:#0a2a35; --panel:#14475a; --accent:#ff6600; --ok:#00aa88; --danger:#cc0000; --muted:#0e3644;
}
*{box-sizing:border-box;}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:#fff;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--accent);font-weight:700;}
header .brand{display:flex;gap:10px;align-items:center;}
header .brand span{font-size:20px;}
header .actions button{margin-left:8px;}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
.card{background:var(--panel);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);}
h2{margin:0 0 12px 0;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;}
input,select,button{width:100%;padding:10px;border:none;border-radius:8px;}
input,select{background:#0e3644;color:#fff;}
button{cursor:pointer;font-weight:700;background:var(--ok);color:#fff;}
button.secondary{background:#274e5e;}
button.danger{background:#cc0000;}
button.warning{background:#b36b00;}
button.accent{background:#ff6600;color:#000;}
.row{display:flex;gap:8px;align-items:center;}
table{width:100%;border-collapse:collapse;background:#0d3a49;border-radius:12px;overflow:hidden;}
th,td{padding:10px;text-align:left;border-bottom:1px solid #164e61;}
th{background:#0b2f3b;}
.right{text-align:right;}
.hidden{display:none;}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0e3644;}
.note{font-size:12px;color:#cfe7ef;}
#full-table th,#full-table td{padding:8px;border:1px solid #164e61;text-align:left;}
#full-table th{background:#0b2f3b;}
#full-table td{background:#0d3a49;}
#full-table button{padding:4px 8px;border:none;border-radius:6px;background:#ff6600;color:#000;cursor:pointer;}
</style>
</head>
<body>
<header>
  <div class="brand"><span>üöë</span><span>SAMS ‚Ä¢ Prise de Service</span></div>
  <div class="actions">
    <button id="btnAdmin" class="secondary hidden" onclick="toggleAdmin()">Panneau Admin</button>
    <button id="btnLogout" class="danger hidden" onclick="logout()">D√©connexion</button>
    <button id="btnSettings" class="secondary hidden" onclick="openSettings()">Param√®tres</button>
  </div>
</header>

<div class="wrap">
  <!-- Connexion -->
  <div class="card" id="login-card">
    <h2>Connexion</h2>
    <div class="grid">
      <input id="username" placeholder="Nom d'utilisateur">
      <input id="password" type="password" placeholder="Mot de passe">
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="login()" class="accent">Se connecter</button>
    </div>
    <p class="note" style="margin-top:8px">Exemple compte : <b>admin/admin123</b></p>
  </div>

  <!-- Tableau personnel -->
  <div class="card hidden" id="service-card">
    <h2>Tableau de Service</h2>
    <div class="grid">
      <div>
        <div><b>Pr√©nom :</b> <span id="w-firstname" class="badge"></span></div>
        <div><b>Nom :</b> <span id="w-lastname" class="badge"></span></div>
        <div><b>Grade :</b> <span id="w-grade" class="badge"></span></div>
        <div><b>Unit√© :</b> <span id="w-unite" class="badge"></span></div>
        <div><b>Agr√©gation :</b> <span id="w-agreg" class="badge"></span></div>
      </div>
      <div>
        <div><b>Statut :</b> <span id="w-status">Hors service</span></div>
        <div><b>Temps total :</b> <span id="w-time">0s</span></div>
        <div><b>Salaire horaire :</b> <span id="w-rate">$0</span></div>
        <div><b>Salaire total :</b> <span id="w-sal">$0</span></div>
        <div><b>Code :</b><select id="w-code"></select></div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnService" onclick="toggleService()">D√©but de Service</button>
    </div>
  </div>

  <!-- Admin -->
  <div class="card hidden" id="admin-card">
    <h2>Administration</h2>
    <div class="grid">
      <input id="adm-new-firstname" placeholder="Pr√©nom">
      <input id="adm-new-lastname" placeholder="Nom">
      <input id="adm-new-username" placeholder="Nom d'utilisateur">
      <input id="adm-new-password" type="password" placeholder="Mot de passe">
      <input id="adm-new-phone" placeholder="T√©l√©phone">
      <select id="adm-new-grade"></select>
      <input id="adm-new-unite" placeholder="Unit√©">
      <input id="adm-new-agreg" placeholder="Agr√©gation(s)">
    </div>
    <div class="row" style="margin-top:10px">
      <button class="accent" onclick="adminCreateUser()">Cr√©er le compte</button>
      <button class="warning" onclick="resetAll()">Remettre √† z√©ro</button>
    </div>
    <h3 style="margin-top:16px">Employ√©s</h3>
    <div class="card" style="background:var(--muted)">
      <table id="adm-table">
        <thead>
          <tr>
            <th>Pr√©nom</th>
            <th>Nom</th>
            <th>Grade</th>
            <th>Unit√©</th>
            <th>Agr√©gation</th>
            <th>T√©l√©phone</th>
            <th class="right">Temps</th>
            <th class="right">Salaire</th>
            <th>Code</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adm-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Param√®tres utilisateur -->
  <div class="card hidden" id="settings-card">
    <h2>Param√®tres</h2>
    <div class="grid">
      <input id="settings-username" placeholder="Nouvel identifiant">
      <input id="settings-password" type="password" placeholder="Nouveau mot de passe">
    </div>
    <div class="row" style="margin-top:10px">
      <button class="accent" onclick="changeCredentials()">Enregistrer</button>
    </div>
  </div>

  <!-- Tableau complet employ√©s en service -->
  <div class="card" id="full-table-card">
    <h2>Employ√©s en service</h2>
    <table id="full-table">
      <thead>
        <tr>
          <th>Pr√©nom</th>
          <th>Nom</th>
          <th>Grade</th>
          <th>Agr√©gation(s)</th>
          <th>Unit√©(s)</th>
          <th>Code</th>
          <th>D√©but du service</th>
          <th>Temps total</th>
          <th>Salaire total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
// --- Config ---
const API_URL='api.php';
const GRADES=['Grand Directeur','Directeur Adjoint','Chef de Service','Superviseur','M√©decin Titulaire','Infirmier','Aide-Soignant','Stagiaire'];
const RATES={'Grand Directeur':25000,'Directeur Adjoint':20000,'Chef de Service':18000,'Superviseur':15000,'M√©decin Titulaire':13000,'Infirmier':6500,'Aide-Soignant':5000,'Stagiaire':0};
const ADMIN_GRADES=['Grand Directeur','Directeur Adjoint','Chef de Service','Superviseur'];
const CODES=[ 'Code 6 ‚öïÔ∏è','Code 3 üöë','Code 0 ü§Ø','Code 1 ü©π','Code 7 ‚òï','Code 10 ü¶¥','Code 10 üîß','Code 15 üöì','Morgue ‚ö∞Ô∏è','Fusillade üíÄ','Consultation ü©∫','Entretien üìã','Formation üè•','Examen üéì','Rendez-vous üìÜ','Convocation üë•','√âv√©nement üéâ','R√©union üö®','Gestion Direction üíº','D√©veloppement Intranet üíª' ];
let currentUser=null;

// --- Helpers ---
async function apiRequest(action,data={}){
  data.action=action;
  const res=await fetch('api.php',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  return res.json();
}
function fmtTime(sec){ sec=Math.max(0,Math.floor(sec||0)); const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60; return `${h}h ${m}m ${s}s`; }
function fmtMoney(n){ return `$${(n||0).toLocaleString('en-US',{maximumFractionDigits:0})}`; }
function fillSelect(sel,arr){ sel.innerHTML=arr.map(v=>`<option value="${v}">${v}</option>`).join(''); }

// --- Auth ---
async function login(){
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value;
  const res=await apiRequest('login',{username:u,password:p});
  if(!res.success){ alert(res.message||'Erreur'); return; }
  currentUser=res.user.username;
  renderUser(res.user);
  buildAdmin();
  document.getElementById('login-card').classList.add('hidden');
  document.getElementById('service-card').classList.remove('hidden');
  document.getElementById('btnLogout').classList.remove('hidden');
  document.getElementById('btnSettings').classList.remove('hidden');
  document.getElementById('btnAdmin').classList.toggle('hidden',!res.user.isAdmin);
  renderFullTable();
}

function logout(){
  currentUser=null;
  document.getElementById('service-card').classList.add('hidden');
  document.getElementById('admin-card').classList.add('hidden');
  document.getElementById('settings-card').classList.add('hidden');
  document.getElementById('btnLogout').classList.add('hidden');
  document.getElementById('btnAdmin').classList.add('hidden');
  document.getElementById('btnSettings').classList.add('hidden');
  document.getElementById('login-card').classList.remove('hidden');
}

// --- Render ---
async function renderUser(u){
  if(!u) u=(await apiRequest('getUser',{username:currentUser})).user;
  document.getElementById('w-firstname').textContent=u.firstname;
  document.getElementById('w-lastname').textContent=u.lastname;
  document.getElementById('w-grade').textContent=u.grade;
  document.getElementById('w-unite').textContent=u.unite||'';
  document.getElementById('w-agreg').textContent=u.agregation||'';
  document.getElementById('w-status').textContent=u.enService?'En service':'Hors service';
  let elapsed = u.enService ? Math.floor((Date.now()-u.startTime)/1000) : 0;
  document.getElementById('w-time').textContent=fmtTime(u.totalSeconds+elapsed);
  document.getElementById('w-rate').textContent=fmtMoney(RATES[u.grade]||0)+' / h';
  document.getElementById('w-sal').textContent=fmtMoney(u.totalSalary + (RATES[u.grade]||0)/3600*elapsed);
  document.getElementById('btnService').textContent=u.enService?'Fin de Service':'D√©but de Service';
  const codeSelect=document.getElementById('w-code'); fillSelect(codeSelect,CODES); codeSelect.value=u.code||CODES[0];
  codeSelect.onchange=async()=>{ u.code=codeSelect.value; await apiRequest('saveUser',{username:currentUser,user:u}); renderFullTable(); buildAdmin(); };
}

// --- Service ---
async function toggleService(){
  const u=(await apiRequest('getUser',{username:currentUser})).user;
  if(!u.enService){ u.enService=true; u.startTime=Date.now(); }
  else{
    const now=Date.now(); const sec=Math.floor((now-u.startTime)/1000);
    u.totalSeconds+=sec; u.totalSalary+=(RATES[u.grade]||0)/3600*sec; u.enService=false; u.startTime=null;
  }
  await apiRequest('saveUser',{username:currentUser,user:u});
  renderUser(u); renderFullTable(); buildAdmin();
}

// --- Full Table ---
async function renderFullTable(){
  const tbody=document.querySelector('#full-table tbody');
  const res=await apiRequest('getAllUsers'); if(!res.success) return;
  tbody.innerHTML=res.users.filter(u=>u.enService || u.startTime).map(u=>{
    let elapsed = u.enService ? Math.floor((Date.now()-u.startTime)/1000) : 0;
    let totalSec=u.totalSeconds+elapsed;
    let totalSal=u.totalSalary+(RATES[u.grade]||0)/3600*elapsed;
    return `<tr>
      <td>${u.firstname}</td><td>${u.lastname}</td><td>${u.grade}</td>
      <td>${u.agregation||''}</td><td>${u.unite||''}</td><td>${u.code}</td>
      <td>${u.startTime?new Date(u.startTime).toLocaleString():'-'}</td>
      <td>${fmtTime(totalSec)}</td><td>${fmtMoney(totalSal)}</td>
    </tr>`;
  }).join('');
}

// --- Admin ---
async function toggleAdmin(){ document.getElementById('admin-card').classList.toggle('hidden'); buildAdmin(); }
async function adminCreateUser(){
  const f=document.getElementById('adm-new-firstname').value.trim();
  const l=document.getElementById('adm-new-lastname').value.trim();
  const u=document.getElementById('adm-new-username').value.trim();
  const p=document.getElementById('adm-new-password').value;
  const ph=document.getElementById('adm-new-phone').value.trim();
  const g=document.getElementById('adm-new-grade').value;
  const un=document.getElementById('adm-new-unite').value.trim();
  const ag=document.getElementById('adm-new-agreg').value.trim();
  if(!u||!p){ alert('Nom et mot de passe requis'); return; }
  await apiRequest('createUser',{username:u,password:p,user:{firstname:f,lastname:l,grade:g,unite:un,agregation:ag,phone:ph,totalSeconds:0,totalSalary:0,enService:false,startTime:null,code:CODES[0]}});
  buildAdmin(); renderFullTable();
}

async function buildAdmin(){
  if(!currentUser) return;
  const res=await apiRequest('getAllUsers'); if(!res.success) return;
  const tbody=document.getElementById('adm-body');
  tbody.innerHTML=res.users.map(u=>{
    return `<tr data-u="${u.username}">
      <td><input value="${u.firstname}"></td>
      <td><input value="${u.lastname}"></td>
      <td><select>${GRADES.map(g=>`<option ${g===u.grade?'selected':''}>${g}</option>`)}</select></td>
      <td><input value="${u.unite||''}"></td>
      <td><input value="${u.agregation||''}"></td>
      <td><input value="${u.phone||''}"></td>
      <td class="right">${fmtTime(u.totalSeconds)}</td>
      <td class="right">${fmtMoney(u.totalSalary)}</td>
      <td><select>${CODES.map(c=>`<option ${c===u.code?'selected':''}>${c}</option>`)}</select></td>
      <td>${u.enService?'En service':'Hors service'}</td>
      <td>
        <button onclick="admSave('${u.username}',this)">Enregistrer</button>
        <button onclick="admDelete('${u.username}')">Supprimer</button>
      </td>
    </tr>`;
  }).join('');
}

async function admSave(u,btn){
  const tr=btn.closest('tr'); if(!tr) return;
  const user={
    firstname:tr.cells[0].querySelector('input').value.trim(),
    lastname:tr.cells[1].querySelector('input').value.trim(),
    grade:tr.cells[2].querySelector('select').value,
    unite:tr.cells[3].querySelector('input').value.trim(),
    agregation:tr.cells[4].querySelector('input').value.trim(),
    phone:tr.cells[5].querySelector('input').value.trim(),
    totalSeconds:parseInt(tr.cells[6].textContent)||0,
    totalSalary:parseInt(tr.cells[7].textContent.replace(/[^0-9]/g,''))||0,
    code:tr.cells[8].querySelector('select').value,
    enService:tr.cells[9].textContent==='En service',
    startTime:null
  };
  await apiRequest('saveUser',{username:u,user});
  if(u===currentUser) renderUser();
  renderFullTable(); buildAdmin();
}

async function admDelete(u){ if(!confirm(`Confirmer la suppression de ${u}?`)) return; await apiRequest('deleteUser',{username:u}); if(u===currentUser) logout(); buildAdmin(); renderFullTable(); }

async function resetAll(){
  if(!confirm('Remise √† z√©ro de tous les employ√©s ?')) return;
  const res=await apiRequest('getAllUsers'); if(!res.success) return;
  for(const u of res.users){ 
    u.totalSeconds=0; u.totalSalary=0; u.enService=false; u.startTime=null; u.code=CODES[0]; 
    await apiRequest('saveUser',{username:u.username,user:u});
  }
  renderFullTable(); renderUser(); buildAdmin();
}

// --- Settings ---
async function openSettings(){
  document.getElementById('settings-card').classList.toggle('hidden');
  const res=await apiRequest('getUser',{username:currentUser});
  if(res.success){ document.getElementById('settings-username').value=res.user.username; }
}
async function changeCredentials(){
  const newU=document.getElementById('settings-username').value.trim();
  const newP=document.getElementById('settings-password').value;
  if(!newU||!newP){ alert('Remplir les deux champs'); return; }
  const res=await apiRequest('getUser',{username:currentUser});
  if(!res.success) return;
  const user=res.user; user.username=newU;
  await apiRequest('createUser',{username:newU,password:newP,user});
  if(newU!==currentUser) await apiRequest('deleteUser',{username:currentUser});
  currentUser=newU;
  alert('Identifiant et mot de passe chang√©s avec succ√®s');
  renderUser(); buildAdmin(); renderFullTable();
}

// --- Init ---
document.addEventListener('DOMContentLoaded',()=>{
  fillSelect(document.getElementById('adm-new-grade'),GRADES);
  fillSelect(document.getElementById('w-code'),CODES);
  setInterval(()=>{ if(currentUser){ renderUser(); renderFullTable(); } },1000);
});
</script>
</body>
</html>
